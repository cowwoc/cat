# Plan: fix-preprocessor-output-tag-detection

## Problem
SkillLoader.processContent() calls parseContent() on RAW skill content before expanding preprocessor
directives (`!` commands). Skills like `status/first-use.md` use `!get-output status` to generate
`<output type="status">` tags dynamically. Since parseContent() runs before expansion, it never
detects these tags, causing the skill to fall into the "content without tags" path. On subsequent
invocations, this returns a generic "already loaded" message instead of fresh output.

## Satisfies
None - bugfix

## Reproduction Code
```java
// first-use.md contains: !`get-output status` which expands to <output type="status">...
// parseContent() is called on raw content (still has !` command) → no <output> found → null
// Falls to non-tag path → subsequent use returns generic "already loaded" message
```

## Expected vs Actual
- **Expected:** First use: instructions in `<instructions>` block + output in `<output skill="X">`.
  Subsequent use: executeRef + fresh `<output skill="X">` with regenerated content.
- **Actual:** First use: raw expanded content returned without wrapping. Subsequent use: generic
  "already loaded" message with no fresh output.

## Root Cause
processContent() calls parseContent(content) on raw unexpanded content at line 234, but the
`<output>` tag is generated by processPreprocessorDirectives() which runs inside substituteVars()
at line 563. The tag detection and content expansion happen in the wrong order.

## Risk Assessment
- **Risk Level:** LOW
- **Regression Risk:** Existing tests with static `<output>` tags still work (expansion is
  idempotent for static content)
- **Mitigation:** TDD - write failing tests first, then fix

## Files to Modify
- client/src/main/java/.../SkillLoader.java - Reorder: expand content before parseContent()
- client/src/test/java/.../SkillLoaderTest.java - Add tests for preprocessor-generated output tags
- client/src/test/java/.../TestSkillOutputWithTag.java - New test helper returning tagged output
- plugin/skills/status/first-use.md - Move echo instruction before `!` command

## Test Cases
- [ ] Preprocessor-generated `<output>` tag detected on first invocation (instructions wrapped)
- [ ] Subsequent invocation returns executeRef + fresh `<output>` block
- [ ] Existing static `<output>` tag tests still pass (no regression)

## Pre-conditions
- [ ] All dependent issues are closed

## Execution Waves

### Wave 1: TDD - Write failing tests
- Create TestSkillOutputWithTag.java that returns `<output type="tag">content</output>`
- Add test: preprocessor directive generating output tag wraps content on first invocation
- Add test: preprocessor directive generating output tag returns fresh output on subsequent invocation
- Verify tests FAIL
  - Files: client/src/test/java/.../TestSkillOutputWithTag.java,
    client/src/test/java/.../SkillLoaderTest.java

### Wave 2: Fix processContent()
- Move substituteVars() call before parseContent() in processContent()
- Remove redundant substituteVars() calls on parsed.instructions() and parsed.outputBody()
- Verify tests PASS
  - Files: client/src/main/java/.../SkillLoader.java

### Wave 3: Update status/first-use.md
- Move echo instruction BEFORE the `!` command (so it lands in instructions section)
- Update instruction to reference `<output skill="status">` (the SkillLoader-wrapped tag name)
  - Files: plugin/skills/status/first-use.md

## Post-conditions
- [ ] All existing SkillLoader tests pass (no regressions)
- [ ] New tests for preprocessor-generated `<output>` tags pass
- [ ] E2E: Empirical test with status skill achieves >= 90% verbatim echo rate
